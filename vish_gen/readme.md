## vish_gen

### description

Generates a 3D table of parton paths traversing the Quark-Gluon Plasma (QGP), using the medium profile generated by Viscous Israel-Stewart Hydrodynamics (VISH). Please give credit to VISH and the [codes](https://github.com/chunshen1987/VISHNew) can be found on github. The module also uses *VEGAS* multi-dimensional numerical integration which can be found in the same repository `vegas-min`.

Let a particle with starting transverse coordinate $(x,y)$ and traversing along an orientation $\theta$, it propagates along a path overlapping with the expansion of the QGP medium. The interaction between the medium and the particle is known as jet quenching which can consist of gluon radiations described by [BDMPS](https://doi.org/10.1088/1126-6708/2001/09/033). The characteristic gluon radiation frequency is given as:
```math
\omega_c=\hat{q}\frac{L^2}{2}=\int d\tau~\hat{q}(\tau)\tau
```
where $\hat{q}$ is the so-called QGP transport coefficient, $L$ the path length, $\tau$ the proper time. Letting the transport coefficient be proportional to the temperature of the medium $\hat{q}\sim T^3$ by the [JET](https://doi.org/10.1103/PhysRevC.90.014909) collaboration. We have the relation $\frac{\hat{q}}{\hat{q}_0}=\frac{T^3}{T_0^3}$, which modifies our equation:
```math
\omega_c\approx C_R\hat{q}_0 \int d\tau~\frac{T(\tau)^3}{T_0^3}\tau
```
where the color factor $C_R=1$ for a quark jet and $C_R=C_A/C_F$ for a gluon jet. $\hat{q}_0$ is the transport coefficient fixed for a quark jet begins at origin $(x=0,y=0,\tau=\tau_0)$, with $\tau_0$ the initialization time of hydro. $T(\tau)$ is the temperature info which can be read from VISH, and $T_0$ the temperature at the origin.

The subroutine reads in the hydro profile data generated by VISH, and generate a 3D table of the format:  

| $x$  | $y$ | $\theta$ | $\int d\tau~(T^3/T_0^3)*\tau$ |
|------|-----|----------|-------------------------------|

A corresponding read module `vish_read` can be found in the same repository. The two modules work together and should be set using the same settings.

### note

- depending on the hydro, we set $\tau_0=0.6$ fm
- the transverse boundaries are set to [-15,+15] fm
- freezeout temperature is set to $T_c=0.154$ GeV: [PRD 90 (2014) 094503](https://doi.org/10.1103/PhysRevD.109.034025)
- The module can also be used to generate a table of path length ($L$) as well.
- we assume no interaction before $\tau_0$, but it can be modified.
- the particle is assume to propagate without transverse deflection and with speed of light, could be modified.
- we also assume no (weak) interaction after freezeout ($T_c$).
- These can all be modified in the integrand function.
- The simple $\hat{q}$ and $T^3$ relation can be modified using other sophisticated relations [article](https://doi.org/10.1007/s41365-024-01492-4).
- This will make use of the flow-velocity info provided also by VISH.
- The generated result is of unit ${\rm fm}^2$, and for $\omega_c$ to be of unit ${\rm GeV}$, $\hat{q}$ has to be of unit ${\rm GeV}\cdot{\rm fm}^{-2}$.

### dependencies

- The jet data generated by VISH `JetData.dat` and `JetCtl.dat` should be in the same directory.
- The VISH Fortran read file should also be in the same directory. If VISH is generated in binary, use `JetOutput-0.8.for`. If generated in HDF5, use `Jetoutputh5.for`.
- VEGAS module should also be in the same directory, and can be found in this repository `vint.f90`
- The VISH read file uses old format of writing common blocks, use `-fno-align-commons` to suppress the warnings.
One can compile with the following:
```
gfortran -c -fno-strict-overflow -fno-align-commons JetOutput-0.8.for vint.f90 vish_gen.f90 main.f90
```

### in-progress

- Current module uses generic format to output data. It can be modified to use binary or HDF5 as output, which can shrink the output file size and increase read speed. 
However, this increase in efficiency might not be significant since the functino is very monotonic and smooth, and there's no need to use dense lattice grids.
- We can also modify this module to read in other hydro profiles instead of the VISH 2+1D hydro. This can provide a diverse comparison of the quenching mechanism.

## Step-by-step usage

### get hydro initial and evolution codes from repositories

We start by creating a working directory `hydro4jet` and clone the necessary repositories into the folder
```bash
mkdir hydro4jet
cd hydro4jet
gh repo clone chunshen1987/superMC
gh repo clone chunshen1987/VISHNew
```

### generate initial collision profile using `superMC`

We need to first generate an initial collision profile using `superMC`
- Go to `superMC` directory
- check `parameters.dat`
- things to take note of:
  -  `ecm` (collision energy)
  -  `bmin`,`bmax` (to set centrality)
  -  `nev` (test a few events first to see how long it takes)
  -  `operation` (set to 3 for average)
  -  `maxx`, `maxy` (default is -15fm to +15fm)
- Run `superMC`
```bash
mkdir build
cd build
cmake ..
make
cp src/superMC.e ../
cd ..
mkdir data
./superMC.e
cd ..
```

### copy data from `superMC` to `VISHNew`
```bash
cp ./superMC/data/sdAvg_order_2_block.dat ./VISHNew/Initial/InitialSd.dat
```

### generate hydro profile using `VISHNew`
- Go to `VISHNew` directory
- check `Vishydro.inp`
- things to take note of:
  - `IInitialization` (set to 2 for reading initial profile from file)
  - `IEin` (use 1 for entropy density)
  - `lattice size` (default is 130, set to 150 to match `superMC` grid size)
- Run `VISHNew`
```bash
mkdir build
sed -i -e '41i    set (CMAKE_Fortran_FLAGS "-w")\' CMakeLists.txt
cd build
cmake ..
make
cp src/VISHNew.e ../
cd ..
mkdir results
./VISHNew.e
cd ..
```

### copy data from `VISHNew` to new directory for analysis
```bash
mkdir gen3Dtable
cp ./VISHNew/results/JetCtl.dat ./gen3Dtable
cp ./VISHNew/results/JetData.dat ./gen3Dtable
cp ./VISHNew/src/JetOutput-0.8.for ./gen3Dtable
cd gen3Dtable
```

### get `vish_gen` from this repository 
```bash
wget https://raw.githubusercontent.com/Raymond-CL/FORTRAN-modules-for-HEP/refs/heads/main/vint/vint.f90
wget https://raw.githubusercontent.com/Raymond-CL/FORTRAN-modules-for-HEP/refs/heads/main/vish_gen/vish_gen.f90
wget https://raw.githubusercontent.com/Raymond-CL/FORTRAN-modules-for-HEP/refs/heads/main/vish_gen/main.f90
```

### generate 3D table with `vish_gen`
- things to take note of in `vish_gen.f90`:
  - `tau0` (should be consistent with $\tau_0$ in `VISHNew`)
  - `xyn`, `thn` (table size will be $(2\times xyn+1)\times(2\times xyn+1)\times thn$ )
  - `Tc` (freeze-out temperature default using LQCD result from PRD, can be modified)
  - `ncall` (MC numerical integration points, for integration accuracy) (1D integration with VEGAS is not so efficient, will modify in the future)
  - results are set to print to output file every loop in $\theta$. One can insert an output to terminal message in the loop to check progress.
- compile and run `vish_gen`
```bash
gfortran -c -fno-strict-overflow -fno-align-commons JetOutput-0.8.for vint.f90 vish_gen.f90 main.f90
gfortran -o generate.exe *.o
./generate.exe
```
- or replace last command with `nohup ./generate.exe &` to run in background
- you can also check the output file `vish.dat` for progress if it is running in background
